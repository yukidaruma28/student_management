<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="studentManagementSystem.testDemo.repository.StudentRepository">

  <!-- 受講生の全件検索 -->
  <select id="searchStudent" resultType="studentManagementSystem.testDemo.data.Student">
    SELECT * FROM student
  </select>

  <!-- 受講生の単一検索 -->
  <select id="searchStudentOne" resultType="studentManagementSystem.testDemo.data.Student">
    SELECT * FROM student WHERE studentId = #{studentId}
  </select>

  <!-- 受講生コース情報の全件検索 -->
  <select id="searchStudentCourseList" resultType="studentManagementSystem.testDemo.data.StudentCourse">
    SELECT * FROM students_courses
  </select>

  <!-- 受講生コース情報に紐づく受講生コース情報の検索 -->
  <select id="searchStudentCourse" resultType="studentManagementSystem.testDemo.data.StudentCourse">
    SELECT * FROM students_courses WHERE studentId = #{studentId}
  </select>

  <!-- 受講生の新規登録 IDについては自動採番 -->
  <insert id="registerStudent" useGeneratedKeys="true" keyProperty="studentId">
    INSERT INTO student
    (
    full_name
    ,furigana
    ,nickname
    ,email
    ,city_name
    ,age
    ,gender
    ,remark
    ,is_deleted
    )
    VALUES
    (
    #{fullName}
    ,#{furigana}
    ,#{nickname}
    ,#{email}
    ,#{cityName}
    ,#{age}
    ,#{gender}
    ,#{remark}
    ,false
    )
  </insert>

  <!-- 受講生コース情報の新規登録 IDについては自動採番 -->
  <insert id="registerStudentCourse" useGeneratedKeys="true" keyProperty="studentsCoursesId">
    INSERT INTO students_courses
    (
    studentId
    ,select_courses
    ,start_date
    ,end_date
    ,student_course_status
    )
    VALUES
    (
    #{studentId}
    ,#{selectCourses}
    ,#{startDate, jdbcType=TIMESTAMP}
    ,#{endDate, jdbcType=TIMESTAMP}
    ,#{studentCourseStatus}
    )
  </insert>

  <!-- 受講生更新 -->
  <update id="updateStudent">
    UPDATE
      student
    SET
      full_name = #{fullName},
      furigana = #{furigana},
      nickname = #{nickname},
      email = #{email},
      city_name = #{cityName},
      age = #{age},
      gender = #{gender},
      remark = #{remark},
      is_deleted = #{isDeleted}
    WHERE
      studentId = #{studentId}
  </update>

  <!-- 受講生コース情報更新 -->
  <update id="updateStudentCourse">
    UPDATE
      students_courses
    SET
      select_courses = #{selectCourses},
      student_course_status = #{studentCourseStatus}
    WHERE
      students_courses_id = #{studentsCoursesId}
  </update>

  <!-- あらゆる条件における検索 -->
  <select id="searchStudentAll" resultType="studentManagementSystem.testDemo.data.Student">
    SELECT DISTINCT
    s.studentId,
    s.full_name,
    s.furigana,
    s.nickname,
    s.email,
    s.city_name,
    s.age,
    s.gender,
    s.remark,
    s.is_deleted
    FROM student s
    LEFT JOIN students_courses sc ON s.studentId = sc.studentId

    <where>
      <if test="student != null and student.fullName != null and student.fullName != ''">
        AND s.full_name LIKE CONCAT('%', #{student.fullName}, '%')
      </if>
      <if test="student != null and student.furigana != null and student.furigana != ''">
        AND s.furigana LIKE CONCAT('%', #{student.furigana}, '%')
      </if>
      <if test="student != null and student.nickname != null and student.nickname != ''">
        AND s.nickname LIKE CONCAT('%', #{student.nickname}, '%')
      </if>
      <if test="student != null and student.email != null and student.email != ''">
        AND s.email LIKE CONCAT('%', #{student.email}, '%')
      </if>
      <if test="student != null and student.cityName != null and student.cityName != ''">
        AND s.city_name = #{student.cityName}
      </if>
      <if test="student != null and student.age != null">
        AND s.age = #{student.age}
      </if>
      <if test="student != null and student.remark != null and student.remark != ''">
        AND s.remark LIKE CONCAT('%', #{student.remark}, '%')
      </if>
      <if test="student != null and student.isDeleted != null">
        AND s.is_deleted = #{student.isDeleted}
      </if>

      <if test="studentCourse != null and studentCourse.selectCourses != null and studentCourse.selectCourses != ''">
        AND sc.select_courses LIKE CONCAT('%', #{studentCourse.selectCourses}, '%')
      </if>
      <if test="studentCourse != null and studentCourse.studentCourseStatus != null and studentCourse.studentCourseStatus != ''">
        AND sc.student_course_status = #{studentCourse.studentCourseStatus}
      </if>
      <if test="studentCourse != null and studentCourse.startDate != null">
        AND sc.start_date &gt;= #{studentCourse.startDate}
      </if>
      <if test="studentCourse != null and studentCourse.endDate != null">
        AND sc.end_date &lt;= #{studentCourse.endDate}
      </if>
    </where>

    ORDER BY s.studentId

  </select>

  <!-- 有効なコース一覧取得 (students_coursesから一意のコース名を取得) -->
  <select id="getActiveCourses" resultType="studentManagementSystem.testDemo.data.CourseMaster">
    SELECT
      ROW_NUMBER() OVER (ORDER BY select_courses) as courseId,
      select_courses as courseName,
      NULL as description,
      TRUE as isActive
    FROM (
      SELECT DISTINCT select_courses
      FROM students_courses
      WHERE select_courses IS NOT NULL AND select_courses != ''
    ) as distinct_courses
    ORDER BY select_courses
  </select>
</mapper>
